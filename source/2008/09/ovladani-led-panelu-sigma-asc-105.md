<!-- dcterms:identifier = aspnetcz#210 -->
<!-- dcterms:title = Ovládání LED panelu Sigma ASC 105 -->
<!-- dcterms:abstract = Sigma ASC 105 je LED panel, který se dá lacino koupit v Makru. Za cenu okolo 2500 Kč se může pochlubit schopnostmi, kterými jinak disponují zařízení s několikanásobnou cenou. Možnost automatizace veškerá žádná, protokol není nijak popsaný, API neexistuje. Hacknul jsem ho a napsal univerzální knihovnu, která umí s panelem spolupracovat. Akorát teď nevím co s ní :) -->
<!-- np9:categoryId = 7 -->
<!-- x4w:category = Software -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2008-09-18T07:53:00+02:00 -->
<!-- dcterms:date = 2008-09-18T07:53:00+02:00 -->

<p><img title="LED panel" style="border-right: 0px; border-top: 0px; margin: 0px 0px 0px 10px; border-left: 0px; border-bottom: 0px" height="208" alt="LED panel" src="https://www.cdn.altairis.cz/Blog/2008/20080917-20080918-ledpanel_3.png" width="349" align="right" border="0"> Proces, jímž se z teček na papíře či z barevných světélek LED vytvářejí písmena a obrazce mne fascinuje už dvacet let. Strašně rád si s podobnými věcmi hraju, takže když jsem v Makru spatřil LED displej Sigma ASC 105, bylo rozhodnuto. Jedná se o jednořádkový trojbarevný svítivý panel, kterému se říká “běžící text” nebo “světelné noviny”. Taková ta věc, kterou najdete třeba v novějších dopravních prostředcích, kterak ukazuje názvy zastávek.</p>  <p>Za cenu okolo 2500 Kč se může pochlubit schopnostmi, kterými jinak disponují zařízení s několikanásobnou cenou. Vkládání textů se děje prostřednictvím dost příšerného dálkového ovládání, nebo ještě příšernějšího programu, který komunikuje přes sériový port. Možnost automatizace veškerá žádná, protokol není nijak popsaný, API neexistuje.</p>  <h2>Jak se hackuje sériová komunikace</h2>  <p>Prvním krokem tedy bylo rozlousknout komunikační protokol. Z logiky věci vyplývá, že s největší pravděpodobností půjde o jednoduchý textový protokol, doplněný nějakými řídícími znaky. V zásadě by tedy mělo stačit poslat do panelu z dodaného programu dostatečné množství známých instrukcí a sledovat, co nám teče po lince.</p>  <p>Možností odposlechu sériové komunikace je několik. Nejrobustnější je hardwarové řešení, ale to jsem neměl k dispozici. Softwarové řešení nabízí třeba HHD Software, dokonce dostupné zdarma. <a href="http://www.serial-port-monitor.com/">Free Serial Port Monitor</a> dokáže odchytávat komunikaci na lince a zobrazovat ji mnoha různými způsoby. Mimochodem: stejná firma nabízí velmi mocné nástroje na sledování téměř čehokoliv, včetně USB a síťové komunikace.</p>  <p>Problém v mém případě spočíval v tom, že používám 64-bitový systém, na kterém popsaný program neběží. To jsem vyřešil pomocí Virtual PC: to umí emulovaný sériový port virtuálního počítače napojit na skuteční COM port hostitele, takže stačilo do virtuálu nainstalovat 32-bitová XPčka a všechno běželo perfektně. Výsledkem usilovného snažení byla stoha papírů, potištěných šestnáctkovými číslicemi.</p>  <p>Pár dnů nato se cestujícím v Pendolinu SC 135 z Prahy do Brna naskytl zajímavý pohled na zarostlého chlapa, an s československým vlčákem u nohou rozkládá po vlakovém stolečku papíry s podivnými hieroglyfy a za polohlasného mumlání po nich čmárá šipky a kolečka.</p>  <h2>Jak se programuje</h2>  <p>Vlastní implementace pak je vcelku triviální, protože sériovou komunikaci zvládá .NET Framework od verze 2.0 velmi dobře. V zásadě se jedná o čtení a zápis do streamu, stejně jako v případě souboru, síťové komunikace a kdečeho dalšího.</p>  <p>Napsal jsem univerzální knihovnu, která umožňuje programovat panel z libovolné .NET aplikace. Její použití je vcelku triviální: Vytvoří se instance třídy <code>Message</code>, do které se pomocí metody <code>Write</code> zapisuje text a speciální znaky, pomocí metody <code>WriteLine</code> se vkládá “nový řádek” s některým z podporovaných přechodových efektů a pomocí odpovídajících metod se nastavuje použitý font a jeho barva. Pomocí třídy <code>ControlClient</code> se potom tato zpráva odešle do panelu. </p>  <p>Zadání složitější zprávy může vypadat nějak takto:</p>  <div style="font-size: 10pt; background: white; color: black; font-family: consolas, monospace">   <p style="margin: 0px"><span style="color: blue">using</span> (<span style="color: #2b91af">Message</span> msg = <span style="color: blue">new</span> <span style="color: #2b91af">Message</span>(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Animation = <span style="color: #2b91af">AnimationType</span>.ScrollUp, Color = <span style="color: #2b91af">Color</span>.LayerMix, Font = <span style="color: #2b91af">Font</span>.Fixed11x07 })) {</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;DEMO OF&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: green">// Using several colors in one line (you can change the font using SetFont method as well)</span></p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Font = <span style="color: #2b91af">Font</span>.Fixed06x07, Color = <span style="color: #2b91af">Color</span>.Red });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;SIGMA &quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.SetColor(<span style="color: #2b91af">Color</span>.Orange);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;ASC 105&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Color = <span style="color: #2b91af">Color</span>.Yellow });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;Control Lib&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Color = <span style="color: #2b91af">Color</span>.Orange, Animation = <span style="color: #2b91af">AnimationType</span>.OpenFromSides });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #2b91af">Glyph</span>.ArrowRight);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.SetColor(<span style="color: #2b91af">Color</span>.Green);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;made by&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.SetColor(<span style="color: #2b91af">Color</span>.Orange);</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #2b91af">Glyph</span>.ArrowLeft);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Color = <span style="color: #2b91af">Color</span>.Yellow, Font = <span style="color: #2b91af">Font</span>.Fixed06x05 });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;Altairis LLC&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Color = <span style="color: #2b91af">Color</span>.Green, Font = <span style="color: #2b91af">Font</span>.Fixed06x07 });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #a31515">&quot;http://www.codeplex.com/SigmaASC105lib/&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine(<span style="color: blue">new</span> <span style="color: #2b91af">LineTransitionOptions</span> { Color = <span style="color: #2b91af">Color</span>.Red, Animation = <span style="color: #2b91af">AnimationType</span>.CoverFromCenter });</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #2b91af">SpecialFunction</span>.CurrentDate);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.WriteLine();</p>    <p style="margin: 0px">&#160;&#160;&#160; msg.Write(<span style="color: #2b91af">SpecialFunction</span>.CurrentTime);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">using</span> (<span style="color: #2b91af">ControlClient</span> client = <span style="color: blue">new</span> <span style="color: #2b91af">ControlClient</span>(PortName)) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.Write(<span style="color: #a31515">&quot;Sending {0} bytes to {1}...&quot;</span>, msg.Length, PortName);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; client.SendMessage(msg);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;OK&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>  <p>Celou knihovnu včetně zdrojového kódu jsem dal k dispozici pod Microsoft Public License (Ms-PL) na <a href="http://www.codeplex.com/SigmaASC105lib/">CodePlex</a>, kdežtě si ji můžete stáhnout.</p>  <p>Tak, a teď ještě pro celou tu věc vymyslet nějaké praktické využití, než na to přijde <a href="http://www.bestijka.cz/">moje přítelkyně</a> a začne mi lát, za co jsem to zase vyhodil prachy :-) Pokud vás něco napadá, dejte mi vědět v komentářích.</p>