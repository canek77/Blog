<!-- dcterms:identifier = aspnetcz#187 -->
<!-- dcterms:title = ASPNET.CZ podporuje Gravatary. Chcete taky? -->
<!-- dcterms:abstract = (aktualizováno) Dnes jsem upgradoval místní publikační systém Nemesis na novou verzi. Nejviditelnější součástí je podpora Gravatarů - uživatelských ikonek u komentářů. Chcete, aby i váš web podporoval Gravatary? Podívejme se, jak na to. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2008-03-12T17:25:22+01:00 -->
<!-- dcterms:date = 2008-03-12T17:25:22+01:00 -->

<p>Dnes jsem aktualizoval Nemesis na nejnovější verzi. Běží pod ASP.NET 3.5, ale pro vás jako čtenáře se nic zásadního nezměnilo. Přibyla jenom podpora technologie Gravatars v komentářích.</p> <h2>Co je Gravatar?</h2> <p>Gravatar je služba, která vám umožní přiřadit ke své e-mailové adrese ikonku, obrázek o rozměru 80x80 px (nebo menší). A když napíšete komentář na server, který tuto službu podporuje, automaticky dokáže tuto ikonku zobrazit.</p> <p>Web služby a možnost registrace najdete na <a href="http://www.gravatar.com">www.gravatar.com</a>.</p> <p>Popis implementace najdete <a href="http://site.gravatar.com/site/implement#section_1_1">na shora uvedeném webu</a>. V zásadě jde o to, že zavoláte URL, kde jako parametr předáte MD5 hash e-mailové adresy a volitelně další parametry, jako požadovaný rozměr obrázku (je čtvercový a maximální délka strany je 80 px) a případně adresu obrázku, který se má zobrazit, pokud k dané e-mailové adrese není zaregistrován žádný avatar.</p> <h2>Jak na něj v ASP.NET?</h2> <p>Jako nejvhodnější řešení jsem zvolil server control, kterému jako parametr dáte e-mailovou adresu a on vyrenderuje element <em>&lt;img&gt;</em> s odpovídajícími parametry:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">using</span> System;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.ComponentModel;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Web;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Web.Security;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">Gravatar</span> : <span style="color: #2b91af">Control</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> UrlFormatNoDefault = <span style="color: #a31515">&quot;http://www.gravatar.com/avatar.php?gravatar_id={0}&amp;size={1}&quot;</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> UrlFormatWithDefault = <span style="color: #a31515">&quot;http://www.gravatar.com/avatar.php?gravatar_id={0}&amp;size={1}&amp;default={2}&quot;</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> DefaultSize = 80;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> DefaultAlternateText = <span style="color: #a31515">&quot;Gravatar&quot;</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;E-mail address to display avatar for.&quot;</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> EmailAddress {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;EmailAddress&quot;</span>]; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;EmailAddress&quot;</span>] = <span style="color: blue">value</span>; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Size of square avatar image in pixels.&quot;</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">DefaultValue</span>(DefaultSize), <span style="color: #2b91af">Themeable</span>(<span style="color: blue">true</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">int</span> Size {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">int</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;Size&quot;</span>]; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">set</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">value</span> &lt; 1 || <span style="color: blue">value</span> &gt; 80) <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentOutOfRangeException</span>(<span style="color: #a31515">&quot;value&quot;</span>, <span style="color: blue">value</span>, <span style="color: #a31515">&quot;Size must be between 1 and 80 pixels.&quot;</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;Size&quot;</span>] = <span style="color: blue">value</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Image to be used in case that avatar is not defined for given e-mail address.&quot;</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">UrlProperty</span>, <span style="color: #2b91af">Themeable</span>(<span style="color: blue">true</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> DefaultImageUrl {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;DefaultImageUrl&quot;</span>]; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;DefaultImageUrl&quot;</span>] = <span style="color: blue">value</span>; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Alternate text to display for avatar image.&quot;</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af">DefaultValue</span>(DefaultAlternateText), <span style="color: #2b91af">Themeable</span>(<span style="color: blue">true</span>)]</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">string</span> AlternateText {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;AlternateText&quot;</span>]; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;AlternateText&quot;</span>] = <span style="color: blue">value</span>; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: blue">void</span> Render(<span style="color: #2b91af">HtmlTextWriter</span> writer) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> hash = <span style="color: #2b91af">FormsAuthentication</span>.HashPasswordForStoringInConfigFile(<span style="color: blue">this</span>.EmailAddress, <span style="color: #a31515">&quot;MD5&quot;</span>).ToLower();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> imageUrl;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(<span style="color: blue">this</span>.DefaultImageUrl)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imageUrl = <span style="color: blue">string</span>.Format(UrlFormatNoDefault, hash, <span style="color: blue">this</span>.Size);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Compute real full URL of default image</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">var</span> ub = <span style="color: blue">new</span> <span style="color: #2b91af">UriBuilder</span>(<span style="color: blue">this</span>.Context.Request.Url);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ub.Query = <span style="color: blue">string</span>.Empty;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ub.Path = <span style="color: blue">this</span>.Page.ResolveUrl(<span style="color: blue">this</span>.DefaultImageUrl);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> defaultUrl = <span style="color: #2b91af">HttpUtility</span>.UrlEncode(ub.Uri.ToString());</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; imageUrl = <span style="color: blue">string</span>.Format(UrlFormatWithDefault, hash, <span style="color: blue">this</span>.Size, defaultUrl);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteBeginTag(<span style="color: #a31515">&quot;img&quot;</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;src&quot;</span>, imageUrl);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;alt&quot;</span>, <span style="color: blue">this</span>.AlternateText);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;width&quot;</span>, <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;{0}px&quot;</span>, <span style="color: blue">this</span>.Size));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;height&quot;</span>, <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;{0}px&quot;</span>, <span style="color: blue">this</span>.Size));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.Write(<span style="color: #2b91af">HtmlTextWriter</span>.SelfClosingTagEnd);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">}</p></div> <p><strong>Úpravy provedené 12. 3. 2008:</strong></p> <ul> <li>Pokud není specifikováno <em>DefaultImageUrl</em>, nepřidává se do questy stringu &quot;default=&quot;.</li> <li>Korektní výpočet plného URL pro <em>DefaultImageUrl.</em></li> <li>Vizuální vlastnosti nastaveny jako skinovatelné</li></ul>