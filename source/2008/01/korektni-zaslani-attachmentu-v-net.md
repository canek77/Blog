<!-- dcterms:identifier = aspnetcz#182 -->
<!-- dcterms:title = Korektní zaslání attachmentu v .NET -->
<!-- dcterms:abstract = Řešil jsem problém s nekorektním zobrazením HTML přílohy v plaintextovém e-mailu. Ukázalo se, že .NET neumí korektně posílat přílohy. Dobrá zpráva je, že se to dá poměrně snadno naučit. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2008-01-30T20:40:25.403+01:00 -->
<!-- dcterms:date = 2008-01-30T20:40:25.403+01:00 -->

<p>Máme webový fakturační systém, který jednou za čas naše věrné zákazníky odmění zasláním pěkného mailu s fakturou. Mail je čistě textový (zasílání HTML mailů považuji za příliš perverzní i na můj vkus), faktura je HTML soubor přiložený k mailu. I stávalo se, že některým uživatelům se mail zobrazil podivně, faktura následovala přímo v těle zprávy za úvodním textem, navíc se zmršenou diakritikou.</p> <p>Bližší vyšetřování ukázalo problém. Pro připojení souboru s attachmentem jsem použil následující naivní volání:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px">msg.Attachments.Add(<span style="color: blue">new</span> <span style="color: #2b91af">Attachment</span>(htmFileName, <span style="color: #a31515">&quot;faktura.htm&quot;</span>));</p></div> <p>Ukázalo se, že .NET ji přidá do zprávy nějak takto:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px">----boundary_1_20f302b2-6cfa-4177-a3c3-093955cfcfe7</p> <p style="margin: 0px">Content-Type: text/html; name=faktura.htm</p> <p style="margin: 0px">Content-Transfer-Encoding: base64</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">77u/PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgU3RyaWN0</p> <p style="margin: 0px">Ly9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXN0cmljdC5k</p></div> <p>Někteří klienti - jako například Microsoft Outlook 2003 v určitém nastavení - pak měly tendenci považovat HTML soubor za část zprávy. Nechci soudit, nakolik v souladu s RFC. Ostatně, MIME je jeden velký maglajz i ve specifikaci, natožpak když dojde na lámání chleba v podobě implementace.</p> <p>Problémem je chybějící hlavička <em>Content-Disposition</em>, která by klientovi řekla, co s nebohými daty má konkrétně udělat. Mohou být například přímo součástí zprávy (obrázky vložené do HTML zprávy), nebo se může jednat o přílohu.</p> <p>Předmětnou hlavičku jest doplniti následujícím kódem:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: green">// Create attachment</span></p> <p style="margin: 0px"><span style="color: blue">using</span> (<span style="color: #2b91af">Attachment</span> att = <span style="color: blue">new</span> <span style="color: #2b91af">Attachment</span>(htmFileName, <span style="color: #a31515">&quot;text/html&quot;</span>)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; att.ContentDisposition.DispositionType = <span style="color: #a31515">&quot;attachment&quot;</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; att.ContentDisposition.CreationDate = <span style="color: #2b91af">DateTime</span>.Now;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; att.ContentDisposition.FileName = <span style="color: #a31515">&quot;faktura.htm&quot;</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; att.ContentDisposition.Inline = <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; msg.Attachments.Add(att);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Send mail</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">SmtpClient</span> mx = <span style="color: blue">new</span> <span style="color: #2b91af">SmtpClient</span>();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; mx.Send(msg);</p> <p style="margin: 0px">}</p></div> <p>Zpráva pak vypadá takto:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px">----boundary_1_3cb74f16-ff7e-4fbb-b85f-52f903667170</p> <p style="margin: 0px">Content-Type: text/html; name=faktura.htm</p> <p style="margin: 0px">Content-Transfer-Encoding: base64</p> <p style="margin: 0px">Content-Disposition: attachment; filename=faktura.htm;</p> <p style="margin: 0px"> creation-date=&quot;30 Jan 2008 19:57:03 +0100&quot;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">77u/PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgU3RyaWN0</p> <p style="margin: 0px">Ly9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXN0cmljdC5k</p></div> <p>Předpokládám, že zmiňovaný problém se projeví téměř výhradně u HTML příloh (a možná ještě RTF), protože nic jiného asi klienti nebudou mít tendenci sami otevírat. V každém případě je dobré o něm vědět.</p>