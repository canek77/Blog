<!-- dcterms:identifier = aspnetcz#243 -->
<!-- dcterms:title = IpAddressValidator – validace IP adresy jako uživatelského vstupu -->
<!-- dcterms:abstract = Píšu webovou aplikaci, která po uživateli chce zadat IP adresu. Samozřejmě si chci pomocí validátoru ověřit, zda jsou zadaná data formálně správná, tedy že uživatel zadal validní IP adresu. Jak na to? Ponaučení první: používejte standardní infrastrukturu. Ponaučení druhé: regulární výrazy nejsou všemocné. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2009-10-10T03:06:07.413+02:00 -->
<!-- dcterms:date = 2009-10-10T03:06:07.413+02:00 -->

<p>Píšu webovou aplikaci, která po uživateli chce zadat IP adresu. Samozřejmě si chci pomocí validátoru ověřit, zda jsou zadaná data formálně správná, tedy že uživatel zadal validní IP adresu. Jak na to? Ponaučení první: používejte standardní infrastrukturu. Ponaučení druhé: regulární výrazy nejsou všemocné.</p>  <p>ASP.NET samozřejmě specializovaným validátorem na IP adresu nedisponují. Pravděpodobně nejvhodnější k použití by na první pohled byl <code>RegularExpressionValidator</code>. Bohužel jenom do doby, než si uvědomíme, že regulární výrazy neumějí příliš zacházet s čísly, zpracovávají je textově. </p>  <p>Velmi snadno jsme schopni ověřit, zda text jsou čtyři 1-3 číslicová čísla oddělená tečkami:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px">\b(?:\d{1,3}\.){3}\d{1,3}\b</p> </div>  <p>Nejsme už ale jednoduše schopni otázat se, zda ona čísla jsou v rozsahu 0-255. Výše popsaný pattern úspěšně zvaliduje třeba i <code>999.999.999.999</code>. Pattern pro &quot;opravdovou&quot; validaci IP adresy existuje, <a href="http://www.regular-expressions.info/examples.html">na webu</a> jsem ho našel takto:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px">\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b</p> </div>  <p>Shora uvedený výraz je nicméně živým důkazem pravdivosti pradávného citátu Jeremy Zawinskeho (<a href="http://regex.info/blog/2006-09-15/247">detaily</a>):</p>  <blockquote>Some people, when confronted with a problem, think &quot;I know, I'll use regular expressions.&quot; Now they have two problems. </blockquote>  <p>Komplikované regulární výrazy jsou cesta do pekel.</p>  <p>Naštěstí .NET Framework disponuje třídou <code>System.Net.IpAddress</code>, která umí parsovat stringy na IPv4 i IPv6 adresy. To nám umožní vyvázat se z nutnosti validovat IP sami, můžeme to hodit na .NET Framework. Zdarma tím získáme i podporu pro IPv6 pro onen nepravděpodobný případ, že by se tato verze někdy začala masově používat.</p>  <p>Jednoduchou logiku zabalíme do validačního prvku, který nazveme <code>IpAddressValidator</code>. Ten podědíme od třídy <code>BaseValidator</code>, která je v .NET Frameowrku právě pro tyto případy. Stačí nám přepsat metodu <code>EvaluateIsValid</code> a dopsat vlastní validační logiku. Kompletní zdrojový kód je zde:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">using</span> System.ComponentModel;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Net;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.WebControls;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">enum</span> <span style="color: #2b91af">IpAddressType</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; IPv4,&#160;&#160; <span style="color: green">// Internet Protocol version 4 address required</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; IPv6,&#160;&#160; <span style="color: green">// Internet Protocol version 6 address required</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Any&#160;&#160;&#160;&#160; <span style="color: green">// Any IP version accepted</span></p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">ToolboxData</span>(<span style="color: #a31515">&quot;&lt;{0}:IpAddressValidator runat=server&gt;&lt;/{0}:IpAddressValidator&gt;&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">IpAddressValidator</span> : <span style="color: #2b91af">BaseValidator</span> {</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;The required version of IP address. Most likely the family you want is IPv4.&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: #2b91af">IpAddressType</span> AddressType {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: #2b91af">IpAddressType</span>)(<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;AddressType&quot;</span>] ?? <span style="color: #2b91af">IpAddressType</span>.IPv4); }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;AddressType&quot;</span>] = <span style="color: blue">value</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: blue">bool</span> EvaluateIsValid() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get string to validate</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">string</span> s = <span style="color: blue">this</span>.GetControlValidationValue(<span style="color: blue">this</span>.ControlToValidate);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Always respond to empty string as valid</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(s)) <span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Try to parse string as IP address</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #2b91af">IPAddress</span> ip;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">bool</span> result = <span style="color: #2b91af">IPAddress</span>.TryParse(s, <span style="color: blue">out</span> ip);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!result) <span style="color: blue">return</span> <span style="color: blue">false</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Check version of IP address</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">switch</span> (<span style="color: blue">this</span>.AddressType) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> <span style="color: #2b91af">IpAddressType</span>.IPv4:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> ip.AddressFamily == System.Net.Sockets.<span style="color: #2b91af">AddressFamily</span>.InterNetwork;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">case</span> <span style="color: #2b91af">IpAddressType</span>.IPv6:</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> ip.AddressFamily == System.Net.Sockets.<span style="color: #2b91af">AddressFamily</span>.InterNetworkV6;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">default</span>:&#160;&#160;&#160; <span style="color: green">// Any</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">true</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>  <p>Po klasické registraci pak můžeme prvek použít stejně jako jakýkoliv jiný validátor:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">altairis</span><span style="color: blue">:</span><span style="color: #a31515">IpAddressValidator</span> <span style="color: red">ID</span><span style="color: blue">=&quot;IpAddressValidator1&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> <span style="color: red">ControlToValidate</span><span style="color: blue">=&quot;TextBoxIpAddress&quot;</span> <span style="color: red">Display</span><span style="color: blue">=&quot;Dynamic&quot;</span> <span style="color: red">ErrorMessage</span><span style="color: blue">=&quot;IP address is invalid&quot;</span> <span style="color: red">Text</span><span style="color: blue">=&quot;*&quot;</span> <span style="color: blue">/&gt;</span></p> </div>  <p>Tento prvek je součástí mého balíčku <strong>Altairis Web UI Controls</strong>, který najdete na <a href="http://altairiswebui.codeplex.com/">CodePlexu</a>. Zatím ještě není v release, ale jenom ve zdrojovém kódu.</p>