<!-- dcterms:identifier = aspnetcz#244 -->
<!-- dcterms:title = Zapamatování hodnoty v cookie pomocí control extenderu -->
<!-- dcterms:abstract = Docela užitečnou funkcionalitou na řadě webů je možnost zapamatovat si hodnotu zadanou do textboxu v cookie, aby ji uživatel nemusel vyplňovat pořád znovu. Typické použití je například v komentářích (i na tomto webu). Psát ji na každém webu zvlášť je ovšem poněkud otravné, chtělo by to nějaké univerzální řešení. Zajímavou cestou je použití Control Extenderů, známých spíše ve světě AJAXu. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2009-10-24T00:44:03.29+02:00 -->
<!-- dcterms:date = 2009-10-24T00:44:03.29+02:00 -->

<p>Docela užitečnou funkcionalitou na řadě webů je možnost zapamatovat si hodnotu zadanou do textboxu v cookie, aby ji uživatel nemusel vyplňovat pořád znovu. Typické použití je například v komentářích (i na tomto webu). Psát ji na každém webu zvlášť je ovšem poněkud otravné, chtělo by to nějaké univerzální řešení. Zajímavou cestou je použití Control extenderů, známých spíše ve světě AJAXu.</p>  <p>Control extendery se objevily v ASP.NET AJAX Extensions pro ASP.NET 2.0, součástí .NET Frameworku jsou od verze 3.0. Control extender je technicky běžný server control, který ale nefunguje samostatně, ale rozšiřuje schopnosti nějakého jiného prvku (v terminologii extenderů se jim říká target controls). Control Extendery tak, jak je známe dnes, se zpravidla používají pro klientské, JavaScriptové funkce. Typickým příkladem je třeba <a href="http://www.asp.net/AJAX/AjaxControlToolkit/Samples/AutoComplete/AutoComplete.aspx"><code>AutoCompleteExtender</code></a>, který rozšiřuje prvek <code>TextBox</code> o schopnost server-driven autocomplete seznamu. Extendery lze nicméně využít i na serverové straně. Typickým případem jsou query extendery v ASP.NET 4.0. A nebo právě <code>CookieStoreExtender</code>, o němž bude řeč níže.</p>  <h2>Základní idea</h2>  <p>O práci s cookies v ASP.NET jsem <a href="http://www.aspnet.cz/Articles/8-susenky-net.aspx">psal už před několika lety</a>, takže nyní budu stručný. Cookies lze vnímat jako jedno nebo dvouúrovňovou strukturu. Cookie může mít buďto jednu stringovou hodnotu a nebo může obsahovat kolekci hodnot, adresovatelných pomocí názvu. K přijatým cookies můžete přistupovat pomocí kolekce <code>Request.Cookies</code> a k odesílaným pomocí <code>Response.Cookies</code>.</p>  <p>Základní idea zapamatování spočívá v tom, že někdy ve fázi Load se podíváme, zda nemáme pro konkrétní <code>TextBox</code> uloženou vhodnou cookie a pokud ano, načteme její hodnotu jako hodnotu tohoto <code>TextBoxu</code>. V event handleru pro událost <code>TextChanged</code> pak změněnou hodnotu uložíme pro další použití.</p>  <p>Ještě je třeba vybudovat infrastrukturu pro práci s cookies, zejména tedy jak se bude cookie i její hodnota jmenovat a jak dlouho vydrží. Pokud cookie nenastavíte datum expirace, bude se pamatovat jenom dokud uživatel nezavře okno prohlížeče, což není pro tento účel příhodné.</p>  <h2>Implementace extenderu</h2>  <p>Extender sám je třída, která je buďto poděděná od base class <code>System.Web.UI.ControlExtender</code> (to budeme používat) a nebo implementuje interface <code>System.Web.UI.IExtenderControl</code> (pro speciální případy). Abychom mohli extendery psát, musíme referencovat assembly <code>System.Web.Extensions.dll</code> ve verzi 1.0 (pro .NET 2.0 nebo 3.0) nebo 3.5 (pro .NET 3.5).</p>  <p>Třídu odekorujeme atributem TargetControlType, kterým řekneme, jaký typ prvku vlastně rozšiřujeme.</p>  <p>Výše uvedená base class nás donutí implementovat metody <code>GetScriptDescriptors</code> a <code>GetScriptReferences</code>. Ty nás v daném okamžiku nezajímají, protože klientské skriptování nebudeme potřebovat. Jejich implementace bude jednoduchá:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Text;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.WebControls;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.ComponentModel;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls {</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">TargetControlType</span>(<span style="color: blue">typeof</span>(<span style="color: #2b91af">TextBox</span>))]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CookieStoreExtender</span> : <span style="color: #2b91af">ExtenderControl</span> {</p>    <p style="margin: 0px">    <p style="margin: 0px"><span style="color: green"></span></p>&#160;&#160; <p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptDescriptor</span>&gt; GetScriptDescriptors(<span style="color: #2b91af">Control</span> targetControl) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptReference</span>&gt; GetScriptReferences() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>Zato potřebujeme vytvořit několik konfiguračních vlastností: <code>CookieName</code>, <code>CookieValueName</code> a <code>CookieExpirationDays</code>. Jejich význam je myslím jasný. Zároveň jsem implementoval rozumné výchozí hodnoty: název cookie je <code>CSEXT</code>, expirace 30 dnů a název hodnoty se určuje podle názvu rozšiřovaného prvku (ve vlastnosti <code>EffectiveCookieValueName</code>).</p>  <p>Zdrojový kód vypadá následovně (změny vyznačeny tučně):</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Text;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.WebControls;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.ComponentModel;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls {</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">TargetControlType</span>(<span style="color: blue">typeof</span>(<span style="color: #2b91af">TextBox</span>))]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CookieStoreExtender</span> : <span style="color: #2b91af">ExtenderControl</span> {</p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> DEFAULT_COOKIE_NAME = <span style="color: #a31515">&quot;CSEXT&quot;</span>;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> DEFAULT_COOKIE_EXPIRATION_DAYS = 30;</strong></p>    <p style="margin: 0px"><strong>&#160;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> CookieStoreExtender() {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.CookieExpirationDays = DEFAULT_COOKIE_EXPIRATION_DAYS;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.CookieName = DEFAULT_COOKIE_NAME;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px"><strong>&#160;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>), <span style="color: #2b91af">DefaultValue</span>(DEFAULT_COOKIE_NAME)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Storage cookie name. Defaults to 'CSEXT'.&quot;</span>)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> CookieName {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieName&quot;</span>]; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieName&quot;</span>] = <span style="color: blue">value</span>; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px"><strong>&#160;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Cookie value name. Defaults to ID of target control.&quot;</span>)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> CookieValueName {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieValueName&quot;</span>]; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieValueName&quot;</span>] = <span style="color: blue">value</span>; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px"><strong>&#160;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>), <span style="color: #2b91af">DefaultValue</span>(DEFAULT_COOKIE_EXPIRATION_DAYS)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Days to cookie expire. Defaults to one month.&quot;</span>)]</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">int</span> CookieExpirationDays {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">int</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieExpirationDays&quot;</span>]; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieExpirationDays&quot;</span>] = <span style="color: blue">value</span>; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px"><strong>&#160;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">string</span> EffectiveCookieValueName {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> {</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(<span style="color: blue">this</span>.CookieValueName)) <span style="color: blue">return</span> <span style="color: blue">this</span>.TargetControlID;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">this</span>.CookieValueName;</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px"><strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</strong></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptDescriptor</span>&gt; GetScriptDescriptors(<span style="color: #2b91af">Control</span> targetControl) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptReference</span>&gt; GetScriptReferences() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>  <p>Zbývá jenom reagovat na událost <code>Load</code> (vlastní) a <code>TextChanged</code> (rozšiřovaného <code>TextBox</code>u). Kompletní zdrojový kód bude tedy vypadat následovně:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">using</span> System;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Collections.Generic;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Linq;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Text;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.WebControls;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.ComponentModel;</p>    <p style="margin: 0px"><span style="color: blue">using</span> System.Web;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls {</p>    <p style="margin: 0px">&#160;&#160;&#160; [<span style="color: #2b91af">TargetControlType</span>(<span style="color: blue">typeof</span>(<span style="color: #2b91af">TextBox</span>))]</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">CookieStoreExtender</span> : <span style="color: #2b91af">ExtenderControl</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">string</span> DEFAULT_COOKIE_NAME = <span style="color: #a31515">&quot;CSEXT&quot;</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">const</span> <span style="color: blue">int</span> DEFAULT_COOKIE_EXPIRATION_DAYS = 30;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> CookieStoreExtender() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.CookieExpirationDays = DEFAULT_COOKIE_EXPIRATION_DAYS;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.CookieName = DEFAULT_COOKIE_NAME;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: blue">void</span> OnLoad(<span style="color: #2b91af">EventArgs</span> e) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">base</span>.OnLoad(e);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get target TextBox</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> targetTextBox = <span style="color: blue">this</span>.NamingContainer.FindControl(<span style="color: blue">this</span>.TargetControlID) <span style="color: blue">as</span> <span style="color: #2b91af">TextBox</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (targetTextBox == <span style="color: blue">null</span>) <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentException</span>(<span style="color: #a31515">&quot;Target control does not exist or is not a TextBox control.&quot;</span>);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Attach handler to store changed value</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; targetTextBox.TextChanged += <span style="color: blue">new</span> <span style="color: #2b91af">EventHandler</span>(TargetTextBox_TextChanged);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Load extended control value from cookie, if exists</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (!<span style="color: blue">this</span>.Page.IsPostBack) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> cookie = <span style="color: blue">this</span>.Page.Request.Cookies[CookieName];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (cookie == <span style="color: blue">null</span>) <span style="color: blue">return</span>;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// no cookie found</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> value = cookie[<span style="color: blue">this</span>.EffectiveCookieValueName];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(value)) <span style="color: blue">return</span>;&#160;&#160;&#160; <span style="color: green">// cookie value is empty</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; targetTextBox.Text = value;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">void</span> TargetTextBox_TextChanged(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get target TextBox</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> tb = sender <span style="color: blue">as</span> <span style="color: #2b91af">TextBox</span>;</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Get or create cookie</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">var</span> cookie = tb.Page.Response.Cookies[<span style="color: blue">this</span>.CookieName];</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (cookie == <span style="color: blue">null</span>) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cookie = <span style="color: blue">new</span> <span style="color: #2b91af">HttpCookie</span>(<span style="color: blue">this</span>.CookieName);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tb.Page.Response.Cookies.Add(cookie);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Update cookie values</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cookie.Expires = <span style="color: #2b91af">DateTime</span>.Now.AddDays(<span style="color: blue">this</span>.CookieExpirationDays);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cookie.Values[<span style="color: blue">this</span>.EffectiveCookieValueName] = tb.Text;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; #region</span> Configuration</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>), <span style="color: #2b91af">DefaultValue</span>(DEFAULT_COOKIE_NAME)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Storage cookie name. Defaults to 'CSEXT'.&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> CookieName {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieName&quot;</span>]; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieName&quot;</span>] = <span style="color: blue">value</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Cookie value name. Defaults to ID of target control.&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">string</span> CookieValueName {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">string</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieValueName&quot;</span>]; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieValueName&quot;</span>] = <span style="color: blue">value</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Category</span>(<span style="color: #a31515">&quot;Cookie&quot;</span>), <span style="color: #2b91af">DefaultValue</span>(DEFAULT_COOKIE_EXPIRATION_DAYS)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<span style="color: #2b91af">Description</span>(<span style="color: #a31515">&quot;Days to cookie expire. Defaults to one month.&quot;</span>)]</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">int</span> CookieExpirationDays {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> { <span style="color: blue">return</span> (<span style="color: blue">int</span>)<span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieExpirationDays&quot;</span>]; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">set</span> { <span style="color: blue">this</span>.ViewState[<span style="color: #a31515">&quot;CookieExpirationDays&quot;</span>] = <span style="color: blue">value</span>; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">private</span> <span style="color: blue">string</span> EffectiveCookieValueName {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">get</span> {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(<span style="color: blue">this</span>.CookieValueName)) <span style="color: blue">return</span> <span style="color: blue">this</span>.TargetControlID;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">return</span> <span style="color: blue">this</span>.CookieValueName;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; #endregion</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; #region</span> ExtenderControl required members</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: green">// Not implemented, because we don't use client scripting here</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptDescriptor</span>&gt; GetScriptDescriptors(<span style="color: #2b91af">Control</span> targetControl) {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: #2b91af">IEnumerable</span>&lt;<span style="color: #2b91af">ScriptReference</span>&gt; GetScriptReferences() {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">yield</span> <span style="color: blue">break</span>;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; #endregion</span></p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <h2>Použití extenderu</h2>  <p>Použití extenderu je velmi jednoduché, po registraci jej použijeme jako běžný control:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 10pt">   <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">TextBox</span> <span style="color: red">ID</span><span style="color: blue">=&quot;SenderNameTextBox&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> <span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">altairis</span><span style="color: blue">:</span><span style="color: #a31515">CookieStoreExtender</span> <span style="color: red">ID</span><span style="color: blue">=&quot;CookieStoreExtender1&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> </p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">TargetControlID</span><span style="color: blue">=&quot;SenderNameTextBox&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">CookieName</span><span style="color: blue">=&quot;GuestBook&quot;</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: red">CookieValueName</span><span style="color: blue">=&quot;Name&quot;</span> <span style="color: blue">/&gt;</span></p> </div>  <p>  <p>Zde nastavujeme ručně název cookie i hodnoty, ale jediným povinným parametrem je <code>TargetControlID</code>.</p>  <p>Popsané řešení zdaleka není jediné možné, ale přijde mi docela zábavné a elegantní.</p>