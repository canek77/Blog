<!-- dcterms:identifier = aspnetcz#167 -->
<!-- dcterms:title = GZIP komprese v .NET: Jak ji poznat a využít? -->
<!-- dcterms:abstract = Jsou vaše data příliš velká? Zkomprimujte je pomocí GZIP komprese, která je vestavěná v .NET Frameworku. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2007-10-15T19:44:24.67+02:00 -->
<!-- dcterms:date = 2007-10-15T19:44:24.67+02:00 -->

<p>S formátem GZIP jste se nepochybně už setkali. Ostatně, pokud používáte běžný prohlížeč, i tato stránka <a title="HTTP komprese v IIS a ASP.NET" href="http://www.aspnet.cz/Articles/2-http-komprese-v-iis-a-asp-net.aspx">byla při přenosu k vám zkomprimována</a> a váš prohlížeč ji rozbalil. Účelem komprimace je snížit objem dat při jejich ukládání a přenosu. Existují v zásadě dva způsoby, jak se toho dá dosáhnout.</p> <p>Ztrátové komprimační algoritmy, jejichž typickým příkladem je komprese používaná v JPEG a MP3 souborech pracuje na principu degradace přesnosti. Využívá omezených schopností lidských smyslů (zraku, sluchu) a vypouští &quot;nadbytečné&quot; detaily, čímž data ztrácejí na objemu. Bývají extrémně účinné, ale mají omezenou použitelnost - nejedná se ani tak o komprimaci, jako o nevratné zničení části informace.</p> <p>Bezztrátové komprimační algoritmy obecně fungují na tom principu, že v datech vyhledávají opakující se sekvence a pomocí &quot;slovníku&quot; je nahrazují kratšími sekvencemi. Jistě znáte klasické archivy typu ZIP, RAR nebo CAB (pamětníci si možná vzpomenou ještě na ARJ a geekové na 7Zip :-). Při procesu dekomprese se data pomocí slovníku přeloží zpátky a původní informace se obnoví v celém rozsahu.</p> <p>Jedním z nejznámějších komprimačních algoritmů je DEFLATE, založený na kombinaci Huffmanova kódování a LZ77. Je popsán v <a title="DEFLATE Compressed Data Format Specification version 1.3" href="http://tools.ietf.org/html/rfc1951">RFC 1951</a>&nbsp;a v prostředí .NET je implementován prostřednictvím třídy <code>System.IO.Compression.DeflateStream</code>. Tento algoritmus se zpravidla nepoužívá v surovém stavu, samostatně, ale jako součást jiného formátu, který umožňuje uložit i metadata, jako například název a atributy původního souboru, kontrolní součet a jiné. </p> <p>Většina uživatelů bude nepochybně znát formát ZIP, který umožňuje sbalit do archivu velké množství souborů spolu s jejich metadaty. ZIP formát interně využívá výše popsaný DEFLATE algoritmus. Podpora tohoto formátu není vestavěná přímo v .NET Frameworku, ale existuje široce používaná volně dostupná knihovna <a title="The Zip, GZip, BZip2 and Tar Implementation For .NET" href="http://www.icsharpcode.net/OpenSource/SharpZipLib/">#ZipLib</a> (SharpZipLib), která umožňuje s těmito archivy pracovat.</p> <p>Velmi často používaný je také formát GZIP, definovaný v <a title="GZIP file format specification" href="http://tools.ietf.org/html/rfc1952">RFC 1952</a>. Jedná se o jednoduché rozšíření nad DEFLATE algoritmem, kdy se zkomprimovaný stream doplní o původní název souboru a kontrolní součet. GZIP se používá buďto samostatně (soubory mají obvykle příponu <code>.gz</code>) a nebo jako součást specifikace jiného formátu či protokolu - typickým příkladem budiž již zmiňovaná HTTP komprese. V .NET Frameworku je podpora pro GZIP formát implementována jako <code>třída System.IO.Compression.GZipStream</code>. </p> <p>Výhodou a současně i omezením GZIPu je, že se jedná o streamovou kompresi a že neumožňuje do jednoho archivu umístit více souborů (narozdíl od ZIPu). Ve světě Unixových systémů se to obvykle řeší tím, že se soubory sloučí do jednoho formátu programem TAR a pak teprve zkomprimují GZIPem - výsledný soubor mívá obvykle příponu <code>.tar.gz,</code> případně <code>.tgz</code>.</p> <h2>Kdy kompresi využít a kdy ne?</h2> <p>Kompresi je vhodné využít v případě, že máte co do činění s daty, která mají velkou režii a jsou snadno komprimovatelná. Typickým zástupcem této kategorie je většina značkovacích jazyků, tedy zejména HTML a XML. Objem složitějších dokumentů v těchto formátech lze snížit klidně řádově.</p> <p>Nutnou podmínkou pro použití GZIP komprese samozřejmě je, aby ji podporovaly obě strany, pokud si máte např. vyměňovat data s jiným programem, musí kompresi podporovat i ten. Nezapomeňte také na to, že po komprimaci přestanou být data na první pohled čitelná pro člověka.</p> <p>Nemá smysl komprimovat data, která už jednou zkomprimovaná jsou. To se týká i řady formátů, které používají kompresi interně, například výše zmiňované JPEG a MPEG soubory (obecně většina formátů používaných pro obrázky, zvuky a video). Týká se to ale třeba i formátů OpenDocument (OpenOffice.org) a OpenXML (Microsoft Office 2007). Oba dva tyto formáty jsou principiálně smečka XML souborů sbalených do ZIP archivu a dále je komprimovat nemá smysl.</p> <p>Komprese obecně nefunguje nad náhodnými daty, resp. nad daty majícími náhodnou charakteristiku. Nemá tedy smysl komprimovat data šifrovaná, protože dobré šifrovací algoritmy dávají na výstupu data náhodné povahy. Je nicméně dobrý nápad data zkomprimovat předtím, než je zašifrujete.</p> <p>Kompresi byste také neměli využívat v případě, že se potýkáte s nedostatkem výpočetní kapacity, protože komprimace a dekomprimace klade zvýšené nároky na procesor a paměť.</p> <h2>Komprimace a dekomprimace dat v kódu</h2> <p>Třídy <code>DeflateStream</code> a <code>GZipStream</code> jsou - jak již název napovídá - poděděné od <code>System.IO.Stream</code>. Jejich konstruktor dostává jako parametr <code>underlying stream</code> (typicky např. soubor, ale může to být i síťové připojení nebo cokoliv jiného) a směr, jakým se operace provádí - tj. komprese nebo dekomprese.</p> <p>Potom stačí&nbsp;do takto vytvořené instance zapisovat (při kompresi) nebo z ní číst (při rozbalování) jako z normálního streamu. Komprimační třída provede odpovídající operace nad tím &quot;spodním&quot; streamem a celá operace je velmi transparentní.</p> <p>Následující kód načte XML dokument ze souboru <code>document.xml</code> a uloží ho zkomprimovaný do souboru <code>document.xml.gz</code>.</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: #2b91af">XmlDocument</span> doc = <span style="color: blue">new</span> <span style="color: #2b91af">XmlDocument</span>();</p> <p style="margin: 0px">doc.Load(<span style="color: #a31515">&quot;document.xml&quot;</span>);</p> <p style="margin: 0px"><span style="color: blue">using</span> (<span style="color: #2b91af">FileStream</span> gzFile = <span style="color: #2b91af">File</span>.Create(<span style="color: #a31515">&quot;document.xml.gz&quot;</span>))</p> <p style="margin: 0px"><span style="color: blue">using</span> (<span style="color: #2b91af">GZipStream</span> gzStream = <span style="color: blue">new</span> <span style="color: #2b91af">GZipStream</span>(gzFile, <span style="color: #2b91af">CompressionMode</span>.Compress)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; doc.Save(gzStream);</p> <p style="margin: 0px">}</p></div> <p>Načtení takto zkomprimovaného souboru by bylo obdobné, pouze by stačilo obrátit směr komprimace a ze streamu číst, ne do něj zapisovat.</p> <h2>Jak poznat GZIP kompresi</h2> <p>Ideální je zařídit, aby se vašem formátu byla komprese nepovinná a aby program dokázal automaticky detekovat, zda byla či nebyla použita. GZIP formát začíná vždy trojici znaků, jejichž šestnáctková hodnota je 0x1F, 0x8B a&nbsp;0x08. Stačí se tedy podívat na začátek souboru a pokud začíná tímto <code>magic number</code>, jde o GZip stream.</p> <h2>Třída GZipXmlDocument</h2> <p>Následující třída rozšiřuje možnosti třídy <code>System.Xml.XmlDocument</code> o práci s komprimovanými daty:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">using</span> System.IO;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.IO.Compression;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Xml;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">GZipXmlDocument</span> : <span style="color: #2b91af">XmlDocument</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: green">// Každý GZIP stream začíná následujícími třemi bajty</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">static</span> <span style="color: blue">readonly</span> <span style="color: blue">byte</span>[] GZipSignature = { 0x1f, 0x8b, 0x08 };</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">override</span> <span style="color: blue">void</span> Load(<span style="color: #2b91af">Stream</span> inStream) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Načíst první tři bajty ze streamu</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">byte</span>[] sig = <span style="color: blue">new</span> <span style="color: blue">byte</span>[3];</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; inStream.Read(sig, 0, 3);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; inStream.Seek(0, <span style="color: #2b91af">SeekOrigin</span>.Begin);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (sig[0] == GZipSignature[0] &amp;&amp; sig[1] == GZipSignature[1] &amp;&amp; sig[2] == GZipSignature[2]) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Je to GZIP signatura - před načtením soubor dekomprimuj</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: #2b91af">GZipStream</span> gzs = <span style="color: blue">new</span> <span style="color: #2b91af">GZipStream</span>(inStream, <span style="color: #2b91af">CompressionMode</span>.Decompress)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">base</span>.Load(gzs);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Není to GZIP signatura - načíst normálně</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">base</span>.Load(inStream);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">override</span> <span style="color: blue">void</span> Load(<span style="color: blue">string</span> filename) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: #2b91af">Stream</span> inStream = <span style="color: #2b91af">File</span>.OpenRead(filename)) <span style="color: blue">this</span>.Load(inStream);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Save(<span style="color: #2b91af">Stream</span> outStream, <span style="color: blue">bool</span> compress) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (compress) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Je požadována komprese</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: #2b91af">GZipStream</span> gzs = <span style="color: blue">new</span> <span style="color: #2b91af">GZipStream</span>(outStream, <span style="color: #2b91af">CompressionMode</span>.Compress)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">base</span>.Save(gzs);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green">// Není požadována komprese</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">base</span>.Save(outStream);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> Save(<span style="color: blue">string</span> filename, <span style="color: blue">bool</span> compress) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">using</span> (<span style="color: #2b91af">Stream</span> outStream = <span style="color: #2b91af">File</span>.Create(filename)) <span style="color: blue">this</span>.Save(outStream, <span style="color: blue">true</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">}</p></div> <p>Třída přepisuje metodu <code>Load</code> a přidává jí schopnost automaticky detekovat GZIP kompresi. Pokud data začínají odpovídajícím magic number, dekomprimují se, jinak se načtou beze změny. Dále pak přidávám dva overloady metody <code>Save</code>, kdy je možno uložit dokument komprimovaně. Řeším pouze metody, které pracují s obecným&nbsp;streamem nebo se soubory, nikoliv metody pracující s <code>TextReader</code>em, <code>XmlReader</code>em a podobně.</p>