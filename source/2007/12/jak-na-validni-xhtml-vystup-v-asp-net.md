<!-- dcterms:identifier = aspnetcz#175 -->
<!-- dcterms:title = Jak na validní XHTML výstup v ASP.NET -->
<!-- dcterms:abstract = ASP.NET se od verze 2.0 chlubí tím, že jimi generovaný kód je validní XHTML. Prvotní nadšení vás přejde v okamžiku, kdy napíšete aplikaci a necháte ji zvalidovat nástrojem od W3C. Správnější by bylo říct, že ASP.NET umí vygenerovat validní XHTML, když mu trochu pomůžete. -->
<!-- np9:categoryId = 1 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2007-12-10T14:04:08.8+01:00 -->
<!-- dcterms:date = 2007-12-10T14:04:08.8+01:00 -->

<p>ASP.NET se od verze 2.0 chlubí tím, že jimi generovaný kód je validní XHTML. Prvotní nadšení vás přejde v okamžiku, kdy napíšete aplikaci a necháte ji zvalidovat nástrojem od W3C. Správnější by bylo říct, že ASP.NET umí vygenerovat validní XHTML, když mu trochu pomůžete. Pojďme se podívat na to, jak by taková pomoc měla vypadat.</p> <p>Nerad bych na tomto místě rozpoutával diskusi o tom, zda má či nemá smysl lpět na XHTML validitě. Dle mého názoru je prostředkem, nikoliv cílem, ale rozhodně se vyplatí vědět, jak takový kód generovat z ASP.NET. Tímto také veřejně přiznávám, že řada mých webů včetně tohoto formální validací neprojde, protože tam nějaké chyby jsou. Vím o nich, vím proč tam jsou a nijak mi nepřekážejí.</p> <p>Tento článek byl inspirován dotazem v diskusní skupině <a href="news://msnews.microsoft.com/microsoft.public.cs.developer">microsoft.public.cs.developer</a> a vychází z dokumentů publikovaných v MSDN Library. Dobrým startovním bodem jest článek <a href="http://msdn2.microsoft.com/en-us/library/exc57y7e.aspx">ASP.NET and XHTML</a>.</p> <h2>Adaptivní rendering</h2> <p>Adaptivní rendering se dnes může jevit jako zbytečný přežitek a komplikace, protože až na pár různých quirků renderují všechny běžně používané prohlížeče rozumně napsaný HTML kód stejně nebo podobně. Ideové základy ASP.NET však byly položeny v dobách, kdy byla válka browserů v plném proudu a rozdíly mezi jednotlivými browsery byly značné. S tím nepochybně bude souhlasit každý, kdo se tvorbou webů zabýval v době, kdy byly aktuální čtyřkové verze prohlížečů.</p> <p>V té době se jako správné řešejí jevil adaptivní rendering. Serverová aplikace detekuje, z jakého klienta na ni uživatel přistupuje, a podle toho mu vyrenderuje kód, který předmětný browser pochopí. Nemusí to být dokonce ani HTML: v dobách, kdy pár optimistů ještě věřilo v úspěch technologie WAP se takto daly renderovat stránky třeba i ve WML.</p> <p>Adaptivní rendering má smysl i dnes, a to při tvorbě webových aplikací pro mobilní zařízení. Zatímco schopnosti dnešních desktopových prohlížečů jsou vcelku vyrovnané, mobilní zařízení mají kromě omezenějších schopností i diametrálně odlišné možnosti a způsoby použití: různé velikosti displeje (od nějakých 160x160 do 800x600), různé způsoby ovládání (numerická klávesnice, rozpoznávání písma...) a je nutné se podle toho k nim chovat.</p> <p>Problém ASP.NET spočívá v tom, že nezná W3C validátor a považuje ho za <em>generic downlevel browser</em>, tedy něco na úrovni zhruba trojkových verzí prohlížečů. Myslí si, že neumí JavaScript, CSS a v podstatě ani pořádně HTML, takže mu renderuje šílený tag soup v nejlepším duchu konce devadesátých let minulého století.</p> <p>Základem veškerých snah zahrnujících použití <a href="http://validator.w3.org/">W3C Validátoru</a> tedy budiž sdělit ASP.NET engine, že něco takového vůbec existuje. Jest tak učiniti pomocí takzvaných <em>Browser Definition Files</em>, které ovlivňují adaptivní rendering. Vytvořte v rootu své aplikace adresář <code>App_Browsers</code> (jeden ze speciálních adresářů, které ASP.NET zná) a v něm vytvořte soubor <code>W3C-Validator.browser</code> (ne názvu nezáleží, důležitá je přípona <code>.browser</code>). Jeho obsah budiž následující:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">browsers</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">browser</span><span style="color: blue"> </span><span style="color: red">id</span><span style="color: blue">=</span>&quot;<span style="color: blue">W3C_Validator</span>&quot;<span style="color: blue"> </span><span style="color: red">parentID</span><span style="color: blue">=</span>&quot;<span style="color: blue">default</span>&quot;<span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">identification</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">userAgent</span><span style="color: blue"> </span><span style="color: red">match</span><span style="color: blue">=</span>&quot;<span style="color: blue">^W3C_Validator</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">identification</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capabilities</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">browser</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">W3C Validator</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">ecmaScriptVersion</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.2</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">javascript</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">true</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">supportsCss</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">true</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">tables</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">true</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">tagWriter</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.UI.HtmlTextWriter</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">capability</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">w3cdomversion</span>&quot;<span style="color: blue"> </span><span style="color: red">value</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">capabilities</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">browser</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">browsers</span><span style="color: blue">&gt;</span></p></div> <p>Tímto zápisem sdělíte ASP.NET, že začíná-li hlavička <code>User-Agent</code> řetězcem <code>W3C_Validator</code>, jedná se o prohlížeč, který umí skiptování, CSS a XHTML. V důsledku toho se bude pro validátor renderovat to samé, co třeba pro IE nebo Firefox.</p> <h2>Použití správného DTD</h2> <p>Následující téma nemá mnoho společného s validitou, ale může vám pomoci při praktickém vytváření fungujících stránek. Vytvoříte-li si ve Visual Studiu novou stránku nebo master page, bude její začátek obvykle vypadat nějak takto:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="background: #ffee62">&lt;%</span><span style="color: blue">@</span> <span style="color: #a31515">Page</span> <span style="color: red">Language</span><span style="color: blue">=&quot;C#&quot;</span> <span style="color: red">AutoEventWireup</span><span style="color: blue">=&quot;true&quot;</span> <span style="color: red">CodeFile</span><span style="color: blue">=&quot;Default.aspx.cs&quot;</span> <span style="color: red">Inherits</span><span style="color: blue">=&quot;_Default&quot;</span> <span style="background: #ffee62">%&gt;</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">&lt;!</span><span style="color: #a31515">DOCTYPE</span> <span style="color: red">html</span> <span style="color: red">PUBLIC</span> <span style="color: blue">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span style="color: blue">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</span></p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">html</span> <span style="color: red">xmlns</span><span style="color: blue">=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">head</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;</span></p></div> <p>Direktiva <code>@Page</code> se sice na klienta nepošle, ale zalomení řádků ano. Specifikaci DOCTYPE tedy budou předcházet dva prázdné řádky. Což je sice z formálního hlediska v pořádku, ale zmate to starší verze Internet Exploreru. </p> <p>Trik spočívá v tom, že prohlížeče obvykle podporují dva režimy práce s dokumentem. Takzvaný &quot;standards compliance mode&quot; a &quot;quirks mode&quot;. Pokud prohlížeč nazná, že dokument psal někdo, kdo umí HTML a ví co dělá, renderuje ho obvykle přesně tak, jak je v dokumentu napsáno. Mezi jednotlivými prohlížeči sice jsou odchylky, ale nikterak dramatické.</p> <p><img height="186" align="left" style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" width="317" border="0" src="https://www.cdn.altairis.cz/Blog/2007/20071210-20071209-docmode_3.gif" alt="Render mode ve Firefoxu"> Pokud prohlížeč dokument identifikuje jako tag soup, nevalidní dokument, bude pracovat v quirks mode. V takovém případě zapojí do renderingu vlastní kreativitu, mnohdy nepřípadnou a v každém případě u různých prohlížečů různou. Drtivá většina stesků typu &quot;prohlížeč X mi zobrazuje tohle jinak než Y&quot; vyplývá z toho, že stránka se renderuje v quirk mode a prohlížeč si tudíž vcelku oprávněně dělá co chce.</p> <p>Nutým předpokladem pro zapnutí strict mode u starších verzí IE je, aby dokument začínal správnou specifikací DOCTYPE. Aby před ní nebyla žádná prázdná řádka, mezera, cokoliv. Mnoho problémů si tedy ušetříte, pokud řádky na začátku dokumentu prohodíte a direktivu <code>@Page</code> resp. <code>@Master</code> napíšete až za DOCTYPE. V případě běžných aplikací bude stačit, když tuto opičárnu provedete jednou, v master page.</p> <p>Bohužel se mi nepodařilo přijít na způsob, jak v IE zjistit, zda stránku renderuje v quirk mode nebo ne. Pravda , nijak zvlášť jsem po tom ani nepátral. Firefox vám tuto informaci ochotně sdělí v okně Page Info (klepněte pravým tlačítkem do stránky a z kontextového menu zvolte Page Info).</p> <h2>Nastavení XHTML conformance mode</h2> <p>Dokumentace tvrdí, že nastavení míry dodržování standardů jest činiti konfiguračně, pomocí elementu <code>xhtmlConformance</code>:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">&lt;?</span><span style="color: #a31515">xml</span><span style="color: blue"> </span><span style="color: red">version</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot;<span style="color: blue">?&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">configuration</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">system.web</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">xhtmlConformance</span><span style="color: blue"> </span><span style="color: red">mode</span><span style="color: blue">=</span>&quot;<span style="color: blue">Strict</span>&quot;<span style="color: blue">/&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">system.web</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">configuration</span><span style="color: blue">&gt;</span></p></div> <p>Atribut <code>mode</code> může nabývat hodnot <code>Legacy</code>, <code>Transitional</code> a <code>Strict</code>. Popis předpokládaných účinků lze nalézti příkladně ve <a href="http://msdn2.microsoft.com/en-us/library/exc57y7e.aspx">shora odkazovaném článku</a>, ale já jsem žádný zřetelný efekt nezaznamenal, controly jako <code>Image</code> nebo <code>HyperLink</code> se (např. atribut <code>alt</code>) renderují pořád stejně blbě. Toto nastavení ve svých aplikacích udržuji spíše z fetišistických důvodů.</p> <h2>Atribut alt u obrázků</h2> <p>V duchu hesla <em>&quot;cesta do pekel je dlážděná dobrými úmysly&quot;</em> učinilo W3C ve své nekonečné moudrosti u obrázku (element <code>img</code>) atribut <code>alt</code> povinným. Onen dobrý úmysl spočívá v tom, že každý obrázek by měl mít textové vyjádření. To se hodí v případě, že uživatel obrázky nemůže nebo nechce zobrazit - aby k němu předmětná informace nějak dolehla i bez nich.</p> <p>Drtivá většina obrázků na současném webu ale žádnou zásadní informaci nenese, jenom dotvářejí design stránky (s čímž HTML příliš nepočítá - řeší sémantickou strukturu webu, ne to, jak web dnes reálně vypadá). V takovém případě by měly mít příslušné obrázky atribut <code>alt</code> také, ale prázdný. Oč lepší je povinný prázdný <code>alt</code> proti nepovinnému jest otázka, na kterou patrně musejí odpovědět chytřejší hlavy, než ta moje.</p> <p>Server control <code>Image</code> disponuje vlastností <code>AlternateText</code>, která - je-li vyplněna - se použije jako hodnota <code>alt</code> atributu. Jest-li tato prázdná, standardně se atribut <code>alt</code> nevyrenderuje v rozporu se specifikací vůbec. Existuje nicméně další vlastnost, <code>GenerateEmptyAlternateText</code>, která může být nastavena na <code>true</code> a jest-li tomu tak, <code>alt</code> se vygeneruje správně tak, jak má - tedy prázdný.</p> <p>Proč na to potřebujeme speciální vlastnost a proč je defaultní nastavení v rozporu se standardem nicméně opět přesahuje omezené schopnosti koňského mozku.</p> <p>Řešením je použít ASP.NET Themes a definovat obsah této vlastnosti v Theme. </p> <h2>Velké problémy s malým HyperLinkem</h2> <p>Je až neuvěřitelné, jak velké problémy může způsobit nemístný optimismus W3C v kombinaci s nezdravou kreativitou na straně Microsoftu. Prvek <code>HyperLink</code> má v tomto směru dva problémy: prvním je již zmíněný <code>alt</code> atribut, jest-li obrázkem a druhým je populární leč zavržený atribut <code>target</code>.</p> <p>Problém s atributem <code>alt</code> je v zásadě stejný, jako u prvku <code>Image</code> až na to, že nemáme k dispozici žádnou vlastnost, kterou bychom si mohli vynutit zobrazení prázdného atributu. Na druhou stranu, u hyperlinku je obecně dobrý nápad <code>Text</code> vyplňovat, aby uživatel věděl, na co kliká. Prázdný <code>alt</code> text lze tedy podle mého zkoumání řešit jenom pomocí adaptéru, viz dále.</p> <p>Druhý problém se týká atributu <code>target</code>. Ten umožňuje odkaz otevřít ve specifikovaném okně, včetně rozličných specialit jako <code>_parent</code>, <code>_top</code> a podobně. Web konsorcium nicméně naznalo, že v zájmu vyšších principů mravních a čistoty jazyka jest třeba atribut <code>target</code> u XHTML vykynožit a podobné skopičiny provádět výhradně prostřednictvím klientského skriptování. Tato idea se setkala s pozoruhodným nedostatkem pochopení u obecné veřejnosti a je patrně nejochotněji porušovanou částí specifikace. Nejsnazší řešení samozřejmě spočívá v tom, že atribut <code>target</code> nebudete používat a správu oken necháte na uživateli. Pokud trváte na tom, že se mu do toho chcete motat a trváte na tom, že musíte být formálně XHTML validní, nezbude, než to zase řešit adaptérem.</p> <h3>HyperLinkAdapter</h3> <p>V úvodu tohoto článku jsem adaptivní rendering spíš pomlouval, ale nyní se nám bude náramně hodit. ASP.NET totiž obsahuje technologii takzvaných control adaptérů. Ve zkratce, jedná se o technologii, která umožňuje delegovat renderování server control na samostatnou třídu, která může být pro každý prohlížeč jiná. A to bez zásahu do controlu samotného.</p> <p>Jest tak činiti tím, že vytvoříte třídu poděděnou od <code>System.Web.UI.Adapters.ControlAdapter</code> a v ní přepíšete metodu <code>Render</code>. Můj adaptér pro control <code>HyperLink</code> vypadá takto:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.Adapters;</p> <p style="margin: 0px"><span style="color: blue">using</span> System.Web.UI.WebControls;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px"><span style="color: blue">namespace</span> Altairis.Web.UI.WebControls.Adapters {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">HyperLinkAdapter</span> : <span style="color: #2b91af">ControlAdapter</span> {</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">protected</span> <span style="color: blue">override</span> <span style="color: blue">void</span> Render(<span style="color: #2b91af">HtmlTextWriter</span> writer) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af">HyperLink</span> link = (<span style="color: #2b91af">HyperLink</span>)(<span style="color: blue">this</span>.Control);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> href = link.NavigateUrl;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!href.StartsWith(<span style="color: #a31515">&quot;#&quot;</span>)) href = <span style="color: blue">this</span>.Page.ResolveUrl(href);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Prepare script for onclick event</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">string</span> onClick = link.Attributes[<span style="color: #a31515">&quot;onclick&quot;</span>] ?? <span style="color: blue">string</span>.Empty;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (onClick != <span style="color: blue">string</span>.Empty &amp;&amp; !onClick.EndsWith(<span style="color: #a31515">&quot;;&quot;</span>)) onClick += <span style="color: #a31515">&quot;;&quot;</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.Target)) onClick += <span style="color: #a31515">&quot;window.open(this.href, \&quot;&quot;</span> + link.Target + <span style="color: #a31515">&quot;\&quot;);&quot;</span>;</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Render link begin tag</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.NavigateUrl)) writer.AddAttribute(<span style="color: #2b91af">HtmlTextWriterAttribute</span>.Href, href);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.CssClass)) writer.AddAttribute(<span style="color: #2b91af">HtmlTextWriterAttribute</span>.Class, link.CssClass);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.ToolTip)) writer.AddAttribute(<span style="color: #2b91af">HtmlTextWriterAttribute</span>.Title, link.ToolTip);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(onClick)) writer.AddAttribute(<span style="color: #2b91af">HtmlTextWriterAttribute</span>.Onclick, onClick);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (link.Style != <span style="color: blue">null</span> &amp;&amp; link.Style.Count &gt; 0) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">foreach</span> (<span style="color: blue">string</span> key <span style="color: blue">in</span> link.Style.Keys) writer.AddStyleAttribute(key, link.Style[key]);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.NavigateUrl)) writer.RenderBeginTag(<span style="color: #2b91af">HtmlTextWriterTag</span>.A);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> writer.RenderBeginTag(<span style="color: #2b91af">HtmlTextWriterTag</span>.Span);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (<span style="color: blue">string</span>.IsNullOrEmpty(link.ImageUrl)) {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Text link</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.Write(link.Text);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">else</span> {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Image link</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteBeginTag(<span style="color: #a31515">&quot;img&quot;</span>);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;src&quot;</span>, Page.ResolveUrl(link.ImageUrl));</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.WriteAttribute(<span style="color: #a31515">&quot;alt&quot;</span>, link.Text);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!link.Width.IsEmpty) writer.WriteAttribute(<span style="color: #a31515">&quot;width&quot;</span>, link.Width.ToString());</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!link.Height.IsEmpty) writer.WriteAttribute(<span style="color: #a31515">&quot;height&quot;</span>, link.Height.ToString());</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (!<span style="color: blue">string</span>.IsNullOrEmpty(link.ToolTip)) writer.WriteAttribute(<span style="color: #a31515">&quot;title&quot;</span>, link.ToolTip);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.Write(<span style="color: #2b91af">HtmlTextWriter</span>.SelfClosingTagEnd);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green">// Render link end tag</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writer.RenderEndTag();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">}</p></div> <p>Použití adaptéru zařídíme opět v souboru s příponou <code>.browser</code> ve složce <code>App_Browsers</code>. Adaptéry lze vyčlenit do samostatného souboru a nebo příslušné elementy zapsat do již existujícího souboru, který naučí ASP.NET rozpoznat validátor:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">browsers</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">browser</span><span style="color: blue"> </span><span style="color: red">refID</span><span style="color: blue">=</span>&quot;<span style="color: blue">Default</span>&quot;<span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">controlAdapters</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">adapter</span><span style="color: blue"> </span><span style="color: red">controlType</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Web.UI.WebControls.HyperLink</span>&quot;<span style="color: blue"> </span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: red">adapterType</span><span style="color: blue">=</span>&quot;<span style="color: blue">Altairis.Web.UI.WebControls.Adapters.HyperLinkAdapter</span>&quot;<span style="color: blue"> /&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">controlAdapters</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">browser</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">browsers</span><span style="color: blue">&gt;</span></p></div> <p>Tento adaptér řeší oba dva v úvodu zmiňované problémy, tedy atributy <code>alt</code> i <code>target</code>. Kromě toho celkově zjednodušuje generované HTML, jak jest vidět na následujícím příkladu:</p> <p>Mějme control zapsaný v ASPX souboru takto:</p> <div style="font-size: 11pt; background: white; color: black; font-family: consolas, courier new, monospace"> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">asp</span><span style="color: blue">:</span><span style="color: #a31515">HyperLink</span> <span style="color: red">ID</span><span style="color: blue">=&quot;HyperLink1&quot;</span> <span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;</span> </p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red">NavigateUrl</span><span style="color: blue">=&quot;none.htm&quot;</span> </p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red">ImageUrl</span><span style="color: blue">=&quot;none.jpg&quot;</span> </p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red">Width</span><span style="color: blue">=&quot;100px&quot;</span> </p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red">Height</span><span style="color: blue">=&quot;100px&quot;</span> </p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: red">Target</span><span style="color: blue">=&quot;_blank&quot;</span> <span style="color: blue">/&gt;</span></p></div> <p>Bez použití adaptérů bude výsledné HTML následující: </p> <p><code>&lt;a id=&quot;HyperLink1&quot; href=&quot;none.htm&quot; target=&quot;_blank&quot; style=&quot;display:inline-block;height:100px;width:100px;&quot;&gt;&lt;img src=&quot;none.jpg&quot; style=&quot;border-width:0px;&quot; /&gt;&lt;/a&gt;</code></p> <p>S použitím adaptéru bude výsledné HTML vypadat takto:</p> <p><code>&lt;a href=&quot;/TestSite/none.htm&quot; onclick=&quot;window.open(this.href, &amp;quot;_blank&amp;quot;);&quot;&gt;&lt;img src=&quot;/TestSite/none.jpg&quot; alt=&quot;&quot; width=&quot;100px&quot; height=&quot;100px&quot; /&gt;&lt;/a&gt;</code></p> <p>Adaptér řeší všechny zde zmiňované problémy s validitou a kromě toho renderuje poněkud konzervativnější markup (kde je specifikována velikost obrázku a ne odkazu). Oproti vestavěnému řešení explicitně nevypíná okraj okolo obrázku, dávám přednost tomu, řešit to v CSS nastavením <code>img { border: none; }</code>. To lze samozřejmě do adaptéru dopsat.</p>