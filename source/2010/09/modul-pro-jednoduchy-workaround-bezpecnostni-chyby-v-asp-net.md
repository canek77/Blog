<!-- dcterms:identifier = aspnetcz#299 -->
<!-- dcterms:title = Modul pro jednoduchý workaround bezpečnostní chyby v ASP.NET -->
<!-- dcterms:abstract = Podařilo se mi napsat a zprovoznit modul, který umožní obejít dříve zmíněnou bezpečnostní chybu v ASP.NET, a to bez zásahu do aplikace samé. Jeho aplikace nevyžaduje žádné specifické znalosti a je velmi jednoduchá. -->
<!-- np9:categoryId = 2 -->
<!-- x4w:category = Bezpečnost -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2010-09-21T05:24:19.993+02:00 -->
<!-- dcterms:date = 2010-09-21T05:24:21.663+02:00 -->
<!-- x4w:pictureWidth = 150 -->
<!-- x4w:pictureHeight = 150 -->
<!-- x4w:pictureUrl = /perex-pictures/20100921-modul-pro-jednoduchy-workaround-bezpecnostni-chyby-v-asp-net.png -->

<p>Podařilo se mi napsat a zprovoznit modul, který umožní obejít <a href="http://www.aspnet.cz/articles/298-kriticka-bezpecnostni-chyba-v-asp-net">dříve zmíněnou bezpečnostní chybu v ASP.NET</a>, a to bez zásahu do aplikace samé. Jeho aplikace nevyžaduje žádné specifické znalosti a je velmi jednoduchá.</p>  <p>Modul si můžete stáhnout na adrese <a title="http://oraclebugfix.codeplex.com/" href="http://oraclebugfix.codeplex.com/">http://oraclebugfix.codeplex.com/</a></p>  <h2>Postup instalace</h2>  <p><strong>Poznámka: </strong>Modul vyžaduje .NET Framework 2.0 a novější a běží jenom na IIS 7.0 a novějších.</p>  <ol>   <li>Stáhněte si nejnovější verzi z <a title="http://oraclebugfix.codeplex.com/" href="http://oraclebugfix.codeplex.com/">http://oraclebugfix.codeplex.com/</a>. </li>    <li>Rozbalte ZIP archiv někam, třeba do <em>C:\OracleFix</em>. </li>    <li>Spusťte soubor <em>install.cmd</em>. Tento skript zaregistruje můj modul do GAC a zároveň do IIS. </li> </ol>  <p>Až budete chtít modul odinstalovat, tak stačí spustit <em>uninstall.cmd</em>, který provede odregistraci z GAC a IIS.</p>  <h2>Jak to funguje</h2>  <p>Modul je ve své podstatě primitivní, jak jest možno zhodnotit nahlédnutím do zdrojového kódu:</p>  <pre style="font-family: "><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System;</font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Security.Cryptography;</font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Threading;</font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">using</font></span><font style="font-size: 12pt"> System.Web;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><span style="color: "><font style="font-size: 12pt" color="#0000ff">namespace</font></span><font style="font-size: 12pt"> Altairis.Web.OracleBugFix {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">class</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">ErrorHandlingModule</font></span><font style="font-size: 12pt"> : </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IHttpModule</font></span><font style="font-size: 12pt"> {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">private</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">const</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">int</font></span><font style="font-size: 12pt"> HTTP_STATUS_CODE = 404;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">private</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">const</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">int</font></span><font style="font-size: 12pt"> HTTP_SUBSTATUS_CODE = 0;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">private</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">const</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">string</font></span><font style="font-size: 12pt"> HTTP_STATUS_TEXT = </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;Object Not Found&quot;</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Dispose() {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Nothing to do here</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">public</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> Init(</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">HttpApplication</font></span><font style="font-size: 12pt"> context) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context.Error += </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">EventHandler</font></span><font style="font-size: 12pt">(context_Error);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">void</font></span><font style="font-size: 12pt"> context_Error(</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">object</font></span><font style="font-size: 12pt"> sender, </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">EventArgs</font></span><font style="font-size: 12pt"> e) {</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Fires when any error occurs</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> app = sender </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">as</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">HttpApplication</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Clear buffered data</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.Clear();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.ClearError();</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Set error response status</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.StatusCode = HTTP_STATUS_CODE;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.SubStatusCode = HTTP_SUBSTATUS_CODE;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.StatusDescription = HTTP_STATUS_TEXT;</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Send error page text</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.ContentType = </font><span style="color: "><font style="font-size: 12pt" color="#a31515">&quot;text/html&quot;</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.Context.Response.Output.Write(Properties.</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Resources</font></span><font style="font-size: 12pt">.ErrorPage);</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Introduce random delay</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">var</font></span><font style="font-size: 12pt"> delay = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">byte</font></span><font style="font-size: 12pt">[1];</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">RandomNumberGenerator</font></span><font style="font-size: 12pt"> rng = </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">new</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">RNGCryptoServiceProvider</font></span><font style="font-size: 12pt">();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rng.GetBytes(delay);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">Thread</font></span><font style="font-size: 12pt">.Sleep((</font><span style="color: "><font style="font-size: 12pt" color="#0000ff">int</font></span><font style="font-size: 12pt">)delay[0]);</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDisposable</font></span><font style="font-size: 12pt"> disposable = rng </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">as</font></span><font style="font-size: 12pt">&#160;</font><span style="color: "><font style="font-size: 12pt" color="#2b91af">IDisposable</font></span><font style="font-size: 12pt">;</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">if</font></span><font style="font-size: 12pt"> (disposable != </font><span style="color: "><font style="font-size: 12pt" color="#0000ff">null</font></span><font style="font-size: 12pt">) { disposable.Dispose(); }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><span style="color: "><font style="font-size: 12pt" color="#008000">// Complete request</font></span></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; app.CompleteRequest();</font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt"> </font></font><br><font face="Consolas"><font style="font-size: 12pt">&#160;&#160;&#160; }</font></font><br><font face="Consolas"><font style="font-size: 12pt">}</font></font><br></pre>

<p>Kód nedělá nic jiného, než že odchytí jakoukoliv chybu a vyhodí ji jako 404, bez ohledu na to, co byla původně.</p>

<p>Podrobnější popis, možnost stažení kompetních zdrojáků i zkompilovaného balíčku najdete na <a title="http://oraclebugfix.codeplex.com/" href="http://oraclebugfix.codeplex.com/">http://oraclebugfix.codeplex.com/</a>.</p>