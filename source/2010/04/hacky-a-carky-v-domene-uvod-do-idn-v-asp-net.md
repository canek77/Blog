<!-- dcterms:identifier = aspnetcz#263 -->
<!-- dcterms:title = Háčky a čárky v doméně – úvod do IDN v ASP.NET -->
<!-- dcterms:abstract = O smysluplnosti, výhodách a problémech národních znaků v doménách (IDN – Internationalized Domain Names) lze vésti disputace velmi dlouho. Nicméně IDN jsou zde a je dobré vědět, jak se s nimi dokáže vyrovnat IIS a ASP.NET. -->
<!-- np9:categoryId = 4 -->
<!-- x4w:category = IT -->
<!-- np9:authorId = 1 -->
<!-- np9:authorEmail = michal.valasek@altairis.cz -->
<!-- dcterms:creator = Michal Altair Valášek -->
<!-- dcterms:created = 2010-04-17T15:35:27.36+02:00 -->
<!-- dcterms:date = 2010-04-17T15:35:27.36+02:00 -->

<p>O smysluplnosti, výhodách a problémech národních znaků v doménách (IDN – Internationalized Domain Names) lze vésti disputace velmi dlouho. Nicméně IDN jsou zde a je dobré vědět, jak se s nimi dokáže vyrovnat IIS a ASP.NET. </p>  <h2>Co je IDN a IRI</h2>  <p>Historicky doménová jména (a od nich odvozená URI) počítají toliko se znaky anglické abecedy. Nebylo tedy možné zaregistrovat si doménu, která obsahuje například znaky s českou diakritikou – nebo čínské či arabské znaky. Tuto situaci řeší technologie IDN (Internationalized Domain Names) a potažmo IRI (Internationalized Resource Identifier). Ta nabízí možnost do doménových jmen vkládat jakékoliv Unicode znaky.</p>  <p>V současné době se správcové jednotlivých top-level domén rozhodují, zda IDN budou ve svých TLD podporovat nebo nikoliv. Správce české národní domény <em>cz</em>, kterým je CZ.NIC, se rozhodl až na další IDN nezavádět, v souladu s výsledky opakovaných průzkumů, v nichž se stále větší počet uživatelů Internetu v ČR vyjadřuje proti zavedení IDN (více <a href="http://www.h&aacute;čkyč&aacute;rky.cz/">zde</a> nebo <a href="http://www.nic.cz/page/451/">zde</a>, pokud váš browser nepodporuje IDN). Z nám blízkých domén IDN podporuje třeba &quot;evropská&quot; TLD <em>eu</em>.</p>  <p>Se zaváděním IDN je spojena celá řada technických a bezpečnostních problémů, které jsou nastíněny například na výše uvedeném webu <a href="http://www.h&aacute;čkyč&aacute;rky.cz">www.háčkyčárky.cz</a> (ano, je tam diakritika). Nehodlám je diskutovat zde, IDN jsou sice mírně vzdálenou, ale přesto realitou, a je dobré vědět, jak s nimi technologicky nakládat.</p>  <p>Proto jsem se rozhodl z edukativních důvodů pro svůj projekt &quot;<strong>Naše tváře</strong>&quot; kromě obvyklé adresy <a href="http://www.nasetvare.eu">www.nasetvare.eu</a> zprovoznit i <a href="http://www.na&scaron;etv&aacute;ře.eu">www.našetváře.eu</a> a podívat se, na jaké problény přitom narazím.</p>  <h2>Kódování Punycode</h2>  <p>Technicky to funguje tak, že daný text (název domény) se zakóduje způsobem popsaným v <a href="http://tools.ietf.org/html/rfc3492">RFC 3492</a> (Punycode). Co do účelu se dí Punycode přirovnat třeba ke kódováním jako Quoted Printable, Base64 nebo UUencode – umožňuje zapsat šestnáctibitové Unicode znaky pomocí omezené znakové sady, která je k dispozici. Tento algoritmus je dosti komplikovaný a rozhodně není intuitivní. Původně se nepředpokládalo, že s ním koncový uživatel přijde do styku.</p>  <p>Pro zakódování a dekódování názvu domény můžete použít například nástroj na webu <a href="http://mct.verisign-grs.com/">VeriSignu</a>. Takže třeba moje příjmení (Valášek) se zakóduje jako <em>xn--valek-zqa01g</em>. Pokud bych si chtěl zaregistrovat doménu <em>valášek.cz</em> (a CZ.NIC to umožňoval), registroval bych si fakticky doménu <em>xn--valek-zqa01g.cz</em> (za normálních okolností nelze zaregistrovat doménu, která by obsahovala dvě pomlčky za sebou).</p>  <h2>Jak to funguje</h2>  <p>Pokud zadáte do prohlížeče adresu, obsahující národní znaky, prohlížeč ji přeloží pomocí Punycode na výše uvedený formát. Ten se použije ve veškeré další komunikaci – pro DNS dotaz, pro hlavičku <em>Host</em> v HTTP requestu a podobně. Reálně tedy potřebujeme podporu na třech místech: v prohlížeči, v DNS serveru, kde má být příslušná doména hostovaná a na web serveru samotném. Posledním článkem řetězu je ASP.NET aplikace, která může adresu, na které běží, ignorovat, a nebo s ní nějak pracovat.</p>  <h3>Prohlížeč</h3>  <p>Vše začíná v prohlížeči, který musí IDN podporovat. Všechny v současné době aktuální browsery IDN zvládají. Výjimkou je stále ještě se občas vyskytující IE 6, který potřebuje speciální plugin. Nicméně IE7, IE8 a aktuální verze Mozilly, Opery, Chrome i Safari IDN podporují. Konkrétní chování záleží na prohlížeči a nastavení – zejména, zda se vám ukáže URL s nabodeníčky a nebo zakódované.</p>  <p>Internet Explorer postupuje podle toho, zda je jazyk, v němž je adresa zapsána, mezi těmi, které si uživatel vybral v nastavení (Tools –&gt; Internet Options –&gt; Languages). Pokud ano, zobrazí tvar se speciálními znaky (a to i pokud původně zadáte tvar kódovaný, tj. <em>xn--*</em>):</p>  <p><a href="https://www.cdn.altairis.cz/Blog/2010/20100417-IDN-enabled_2.png"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="IDN-enabled" border="0" alt="IDN-enabled" src="https://www.cdn.altairis.cz/Blog/2010/20100417-IDN-enabled_thumb.png" width="571" height="387"></a> Pokud jazyk, v němž je adresa zapsána, nepatří mezi podporované, ukáže se adresa v zakódovaném tvaru a navíc se zobrazí varování, že adresa obsahuje znaky nekompatibilní se současným jazykovým nastavením:</p>  <p><a href="https://www.cdn.altairis.cz/Blog/2010/20100417-IDN-disabled_2.png"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="IDN-disabled" border="0" alt="IDN-disabled" src="https://www.cdn.altairis.cz/Blog/2010/20100417-IDN-disabled_thumb.png" width="569" height="114"></a> </p>  <p>  <p>Na mém nastavení (anglický systém a české regionální nastavení) se anglické nejnovější verze ostatních prohlížečů chovaly následovně: Chrome a Firefox zobrazil adresu v zakódovaném tvaru, Opera a Safari se speciálními znaky. Všechny prohlížeče ale zobrazily výslednou stránku v pořádku. Předpokládám, že v případě ostatních prohlížečů je chování řízeno nějakými nastaveními, ale do hloubky jsem ho nezkoumal.</p>  <h3>DNS Server</h3>  <p>DNS server autoritativní pro danou doménu musí být schopen opečovávat zónu pro IDN doménu. Což obvykle nebývá problém, Microsoft DNS Server, který je součástí Windows 2003, Windows 2008 i Windows 2008 R2 to bez problémů zvládl. Doménu definujte v punnycode tvaru stejně, jak každou jinou.</p>  <h3>Web Server</h3>  <p>Pokud máte pro každý web samostatnou IP adresu (resp. samostatný TCP endpoint, abychom byli korektní), web server host name vůbec nezajímá a nijak ho neřeší. V praxi ale obvykle využíváme vymožeností HTTP verze 1.1 a na jedné IP hostujeme webů několik a rozlišujeme mezi nimi prostřednictvím host name, které nám prohlížeč pošle v hlavičce &quot;host&quot;. IIS se kombinace IP adresy, portu a host name nazývá &quot;binding&quot;. IDN jsou podporovány a zadávají se v nezakódovaném tvaru, tj. do pole &quot;host name&quot; napíšete doménu s háčky a čárkami.</p>  <h3>ASP.NET</h3>  <p>Do .NET frameworku se podpora IDN a IRI dostala ve verzích 2.0 SP1 resp. 3.0 SP1. Je ovšem nutné ji explicitně zapnout v konfiguraci, v souboru <em>web.config</em>:</p>  <div style="font-family: consolas, &#39;Courier New&#39;, monospace; background: white; color: black; font-size: 13pt">   <p style="margin: 0px"><span style="color: blue">&lt;?</span><span style="color: #a31515">xml</span><span style="color: blue"> </span><span style="color: red">version</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot;<span style="color: blue">?&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">configuration</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;</span><span style="color: #a31515">configSections</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">section</span><span style="color: blue"> </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">uri</span>&quot;<span style="color: blue"> </span><span style="color: red">type</span><span style="color: blue">=</span>&quot;<span style="color: blue">System.Configuration.UriSection, System, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</span>&quot;<span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">configSections</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;</span><span style="color: #a31515">uri</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">idn</span><span style="color: blue"> </span><span style="color: red">enabled</span><span style="color: blue">=</span>&quot;<span style="color: blue">All</span>&quot;<span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span><span style="color: #a31515">iriParsing</span><span style="color: blue"> </span><span style="color: red">enabled</span><span style="color: blue">=</span>&quot;<span style="color: blue">true</span>&quot;<span style="color: blue">/&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&#160;&#160;&#160; &lt;/</span><span style="color: #a31515">uri</span><span style="color: blue">&gt;</span></p>    <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">configuration</span><span style="color: blue">&gt;</span></p> </div>  <p>Ve verzi 4.0 je už sekce <em>&lt;uri&gt;</em> standardně registrována a není nutno ji registrovat.</p>  <p>  <p>Atribut <em>idn/@enabled</em> řeší zpracování punnycode v doménovém jméně, tj. v názvu serveru. Může nabývat třech hodnot: Výchozí je <em>None</em>, kdy je podpora IDN vypnuta. Pokud se tedy zeptáte např. na hodnotu vlastnosti <em>Request.Url.Host</em>, dostane se vám zakódovaných dat s <em>xn--</em> na začátku. Hodnota <em>All</em> podporu IDN zapne ve všech případech. Hodnota <em>AllExceptIntranet</em> zapne překlad pouze pro internetové adresy, ne pro lokální intranet.</p>  <p>Atribut <em>iriParsing/@enabled</em> řeší zpracování punnycode v ostatních částech URI, tj. např. jako název složky nebo souboru. Má hodnotu <em>True</em> nebo <em>False</em> (default).</p>  <h2>Závěr</h2>  <p>Microsoft platforma pro web s IDN a IRI nemá problém. Prohlížeče, DNS, web server i ASP.NET si dokáží s oháčkovanými doménami poradit. Pokud si chcete IDN jen tak vyzkoušet, můžete si ho vyzkoušet na subdoménách pod svou kontrolou, omezení CZ.NIC se vztahuje jenom na název domény druhé úrovně, na nic jiného – viz například adresu <a href="http://test&iacute;ček.byte.cz">http://testíček.byte.cz</a> (není tam nic zajímavého, ale server vám odpoví). S dalšími síťovými službami už je to horší. Rozchodit na IDN doméně korektně například e-mail už je výrazně obtížnější. Stejně tak praktická použitelnost IDN webů je limitovaná, protože řada systémů (včetně tohoto) vám nedovolí URL s háčky a čárkami zadat, o čemž se přesvědčil jeden ze čtenářů toho webu, když mi poslal mail se stížností, že nemůže do komentáře zadat adresu svého nového IDN webu.</p>